# 高性能MySQL笔记

InnoDB 采用MVCC来支持高并发，并且实现了四个标准的隔离级别。默认隔离级别时REPEATABLE READ(可重复读)，并且通过**间隙锁**（next-key locking）策略防止幻读的出现。间隙锁使得InnoDB不仅仅锁定查询涉及的行，还会对索引种的间隙进行锁定，以防止幻影行的插入。

| 隔离级别                  | 脏读 | 不可重复读 | 幻读 |
| :------------------------ | :--: | :--------: | :--: |
| READ UNCOMMITED(未提交读) |  Y   |     Y      |  Y   |
| READ COMMITED(读提交)     |  N   |     Y      |  Y   |
| REPEATABLE READ(可重复读) |  N   |     N      |  Y   |
| SERIALIZABLE(可串行化)    |  N   |     N      |  N   |

## MyISAM存储引擎

MySQL5.1以及之前的版本默认的存储引擎。

特性：

- 全文索引
- 压缩
- 空间函数（GIS）

MyISAM不支持事务和行级锁，而且有一个毫无疑问的缺陷就是崩溃后无法安全恢复。

### 存储

.frm 表结构存储文件

MyISAM会将表存储在两个文件中：

- 数据文件（.MYD）
- 索引文件（.MYI）

MyISAM表可以包括动态和静态（长度固定）行

MyISAM表可以存储的行记录数，一般受限于可用的磁盘空间，或者操作系统中单个文件的最大尺寸。

### 特性

- 加锁与并发

  MyISAM对整张表加锁，而不是针对行。读取时会需要读到的所有表加共享锁，写入时则对表加排它锁。但是在表有读取查询的同时，也可以往表中插入新的记录（这被称为并发插入，CONCURRENT INSERT）

- 修复

  可以手工或者自动执行检查和修复操作，但这里说的修复和事务恢复以及崩溃恢复是不同的概念。执行表的修复可能导致一些数据的丢失，而且修复操作是非常慢的。可以通过CHECK TABLE mytable检查表的错误，如果有错误可以通过执行REPAIR TABLE mytable进行修复。另外，如果MySQL服务器以及关闭，也可以通过myisamchk命令行工具进行检查和修复操作。

- 索引特性

  对于MyISAM表，即使是BLOB和TEXT等长字段，也可以基于其前500个字符创建索引。MyISAM也支持全文索引，这是一种基于分词创建的索引，可以支持复杂的查询。

- 延迟更新索引键（Delayed Key Write）

  创建MyISAM表的时候，如果指定了DELAY_KEY_WRITE选项，在每次修改执行完成时，不会立刻将修改的索引数据写入磁盘，而是会写到内存中的键缓冲区（in-memory key buffer），只有在清理键缓冲区或者关闭表的时候才会将对应的索引块写入到磁盘。这种方式可以极大的提升写入性能，但是在数据库或者主机崩溃时会造成索引损坏，需要执行修复操作。延迟更新索引键的特性，可以在全局设置，也可以为单个表设置。

### MyIASM压缩表

如果表在创建并导入数据以后，不会再进行修改操作，那么这样的表或许适合采用MyISAM压缩表。

可以使用myisampack对MyISAM表进行压缩（也叫打包pack）。压缩表是不能进行修改的（除非先将表解除压缩，修改数据，然后再次压缩）。压缩表可以极大地减少磁盘空间占用，因此也可以减少磁盘I/O，从而提升查询性能。压缩表也支持索引，但索引也是只读的。

以现在的硬件能力，对大多数应用场景，读取压缩表数据时的解压带来的开销影响并不大，而减少I/O带来的好处则要大得多。压缩时表中的记录是独立压缩的，所以读取单行的时候不需要去解压整个表（甚至也不解压行所在的整个页面）。

### MyISAM性能

MyISAM引擎设计简单，数据以紧密格式存储，所以再某些场景下的性能很好。

MyISAM有一些服务器级别的性能扩展机制，比如对索引键缓冲区（key cache）的Mutex锁，MariaDB基于段（segment）的索引键缓冲区机制来避免该问题。但MyISAM最典型的性能问题还是表锁的问题，如果你发现所有的查询都长期处于“Locked”的状态，那么毫无疑问表锁就是罪魁祸首。

### 转换表的引擎

- ALTER TABLE

  ALTER TABLE mytable ENGINE = InnoDB;

  上述语法可以适合任何存储引擎。但是有一个问题：需要执行很长时间。MySQL会执行将数据从原表复制到一张新的表中，在复制期间可能会消耗系统所有的I/O能力，同时原表上会加上读锁。所以，在繁忙的表上执行此操作要特别小心。

  如果转换表的存储引擎，将会失去和原引擎相关的所有特性。

- 导入与导出

  使用mysqldump工具将数据导出到文件，然后修改文件中CREATE TABLE语句的存储引擎选项，注意同时修改表名，因为同一个数据库中不能存在相同的表名，即使它们使用的是不同的存储引擎。

- 创建与查询（CREATE和SELECT）

## 服务器性能剖析

### 通过性能剖析进行优化

性能剖析是测量和分析时间花费在哪里的主要方法。性能剖析一般有两个步骤：测量任务所花费的时间；然后对结果进行统计和排序，将重要的任务排到前面。



- 执行时间
- 等待时间

New Relic

